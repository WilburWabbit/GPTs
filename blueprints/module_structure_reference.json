{
  "metadata": {
    "version": 2,
    "designer": {
      "layout": "horizontal"
    }
  },
  "name": "Module structure reference",
  "description": "Minimal Make scenario export capturing the precise module metadata schema for the Start eBay OAuth flow reference.",
  "main": true,
  "modules": [
    {
      "id": 1,
      "name": "Incoming request",
      "type": "module",
      "app": "webhook",
      "action": "customWebhook",
      "parameters": {
        "hookName": "reference_hook",
        "payloadType": "json",
        "respondImmediately": false
      },
      "metadata": {
        "designer": {
          "x": 0,
          "y": 0,
          "width": 160,
          "height": 80
        }
      },
      "module": "webhook:customWebhook",
      "moduleType": "trigger",
      "version": 3
    },
    {
      "id": 2,
      "name": "Lookup in datastore",
      "type": "module",
      "app": "datastore",
      "action": "searchRecords",
      "parameters": {
        "datastoreId": "{{connections.reference_store}}",
        "query": {
          "field": "key",
          "relation": "equals",
          "value": "{{1.body.id}}"
        },
        "limit": 1
      },
      "metadata": {
        "designer": {
          "x": 220,
          "y": 0,
          "width": 160,
          "height": 80
        }
      },
      "module": "datastore:searchRecords",
      "moduleType": "search",
      "version": 2
    },
    {
      "id": 3,
      "name": "Handle outcomes",
      "type": "router",
      "routes": [
        {
          "id": "found",
          "name": "Record found",
          "filter": "{{ length(2) > 0 }}"
        },
        {
          "id": "missing",
          "name": "Record missing",
          "filter": "{{ length(2) = 0 }}"
        }
      ],
      "metadata": {
        "designer": {
          "x": 440,
          "y": 0,
          "width": 160,
          "height": 80
        }
      },
      "module": "router",
      "moduleType": "router",
      "version": 1
    },
    {
      "id": 4,
      "name": "Compose found payload",
      "type": "module",
      "app": "json",
      "action": "createJSONObject",
      "parameters": {
        "structure": [
          {
            "name": "status",
            "type": "text",
            "value": "found"
          },
          {
            "name": "record",
            "type": "array",
            "value": "{{ map(2; 'value') }}"
          }
        ]
      },
      "metadata": {
        "designer": {
          "x": 660,
          "y": -140,
          "width": 160,
          "height": 80
        }
      },
      "module": "json:createJSONObject",
      "moduleType": "action",
      "version": 1
    },
    {
      "id": 5,
      "name": "Return found",
      "type": "module",
      "app": "webhook",
      "action": "customWebhookResponse",
      "parameters": {
        "statusCode": 200,
        "body": "{{4.json}}",
        "headers": [
          {
            "name": "Content-Type",
            "value": "application/json"
          }
        ]
      },
      "metadata": {
        "designer": {
          "x": 880,
          "y": -140,
          "width": 160,
          "height": 80
        }
      },
      "module": "webhook:customWebhookResponse",
      "moduleType": "action",
      "version": 2
    },
    {
      "id": 6,
      "name": "Generate state",
      "type": "module",
      "app": "tools",
      "action": "generateUuid",
      "parameters": {},
      "metadata": {
        "designer": {
          "x": 660,
          "y": 140,
          "width": 160,
          "height": 80
        }
      },
      "module": "tools:generateUuid",
      "moduleType": "action",
      "version": 1
    },
    {
      "id": 7,
      "name": "Compose URL",
      "type": "module",
      "app": "tools",
      "action": "composeString",
      "parameters": {
        "structure": "https://example.test/auth?state={{6.uuid}}"
      },
      "metadata": {
        "designer": {
          "x": 880,
          "y": 140,
          "width": 160,
          "height": 80
        }
      },
      "module": "tools:composeString",
      "moduleType": "action",
      "version": 1
    },
    {
      "id": 8,
      "name": "Save reference record",
      "type": "module",
      "app": "datastore",
      "action": "createOrUpdateRecord",
      "parameters": {
        "datastoreId": "{{connections.reference_store}}",
        "key": "{{1.body.id}}",
        "data": {
          "state": "{{6.uuid}}",
          "updated_at": "{{ now }}"
        }
      },
      "metadata": {
        "designer": {
          "x": 1100,
          "y": 140,
          "width": 160,
          "height": 80
        }
      },
      "module": "datastore:createOrUpdateRecord",
      "moduleType": "action",
      "version": 2
    },
    {
      "id": 9,
      "name": "Return consent",
      "type": "module",
      "app": "webhook",
      "action": "customWebhookResponse",
      "parameters": {
        "statusCode": 200,
        "body": "{\"status\":\"consent_required\",\"url\":\"{{7.text}}\",\"state\":\"{{6.uuid}}\"}",
        "headers": [
          {
            "name": "Content-Type",
            "value": "application/json"
          }
        ]
      },
      "metadata": {
        "designer": {
          "x": 1320,
          "y": 140,
          "width": 160,
          "height": 80
        }
      },
      "module": "webhook:customWebhookResponse",
      "moduleType": "action",
      "version": 2
    }
  ],
  "links": [
    {
      "id": 1,
      "from_module": 1,
      "to_module": 2
    },
    {
      "id": 2,
      "from_module": 2,
      "to_module": 3
    },
    {
      "id": 3,
      "from_module": 3,
      "to_module": 4,
      "route": "found"
    },
    {
      "id": 4,
      "from_module": 4,
      "to_module": 5,
      "route": "found"
    },
    {
      "id": 5,
      "from_module": 3,
      "to_module": 6,
      "route": "missing"
    },
    {
      "id": 6,
      "from_module": 6,
      "to_module": 7,
      "route": "missing"
    },
    {
      "id": 7,
      "from_module": 7,
      "to_module": 8,
      "route": "missing"
    },
    {
      "id": 8,
      "from_module": 8,
      "to_module": 9,
      "route": "missing"
    }
  ],
  "connections": {
    "reference_store": {
      "name": "Reference store",
      "type": "datastore"
    }
  }
}
